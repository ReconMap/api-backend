<?php declare(strict_types=1);

namespace Reconmap\Controllers\Vulnerabilities;

use Psr\Http\Message\ServerRequestInterface;
use Psr\Http\Message\StreamInterface;
use Reconmap\ControllerTestCase;
use Reconmap\Models\Vulnerability;
use Reconmap\Repositories\CustomFieldRepository;
use Reconmap\Repositories\VulnerabilityRepository;
use Symfony\Component\HttpFoundation\Response;

class CreateVulnerabilityControllerTest extends ControllerTestCase
{
    public function testSuccess(): void
    {
        $userId = 1;

        $request = $this->createMock(ServerRequestInterface::class);
        $request->expects($this->once())
            ->method('getAttribute')
            ->with('userId')
            ->willReturn($userId);

        $mockStream = $this->createMock(StreamInterface::class);
        $mockStream->expects($this->any())->method('getContents')->willReturn(json_encode(['project_id' => 1, 'summary' => 'SQL injection', 'risk' => 'low', 'tags' => null]));

        $request->expects($this->atLeastOnce())
            ->method('getBody')
            ->willReturn($mockStream);

        $vulnerability = new Vulnerability();
        $vulnerability->project_id = 1;
        $vulnerability->creator_uid = $userId;
        $vulnerability->summary = 'SQL injection';
        $vulnerability->risk = 'low';
        $vulnerability->tags = null;
        $vulnerability->custom_fields = '[]';

        $mockVulnerabilityRepository = $this->createPartialMock(VulnerabilityRepository::class, ['insert']);
        $mockVulnerabilityRepository->expects($this->once())
            ->method('insert')
            ->with($vulnerability)
            ->willReturn(5);

        $mockCustomFieldRepository = $this->createMock(CustomFieldRepository::class);

        $controller = $this->injectController(new CreateVulnerabilityController($mockVulnerabilityRepository, $mockCustomFieldRepository));
        $response = $controller($request);

        $this->assertEquals(Response::HTTP_CREATED, $response->getStatusCode());
        $this->assertEquals('{"id":5,"insert_ts":null,"update_ts":null,"creator_uid":1,"is_template":false,"external_id":null,"project_id":1,"target_id":null,"category_id":null,"summary":"SQL injection","description":null,"external_refs":null,"visibility":"public","risk":"low","proof_of_concept":null,"impact":null,"remediation":null,"remediation_complexity":null,"remediation_priority":null,"cvss_score":null,"cvss_vector":null,"tags":null,"owasp_vector":null,"owasp_likehood":null,"owasp_impact":null,"owasp_overall":null,"custom_fields":"[]"}', (string)$response->getBody());
    }
}
